<div class="container mt-5">
  <%= form_with(url: search_results_path, method: :get, local: true) do |form| %>
    <div class="search-bar">
      <div class="search-item">
        <i class="fas fa-dot-circle"></i>
        <span>
          <%= form.text_field :departure_city, class: 'form-control', placeholder: 'Departure', id: 'departure_city_select', autocomplete: 'off' %>
        </span>
      </div>
      <div class="search-item">
        <i class="fas fa-dot-circle"></i>
        <span>
          <%= form.text_field :arrival_city, class: 'form-control', placeholder: 'Arrival', id: 'arrival_city_select', autocomplete: 'off' %>
        </span>
      </div>
      <div class="search-item">
        <i class="fas fa-calendar-alt"></i>
        <span>
          <%= form.text_field :date, class: 'form-control flatpickr', id: 'date_field', placeholder: 'Today' %>
        </span>
      </div>
      <button class="search-button">
        <%= form.submit "Search", class: 'btn' %>
      </button>
    </div>
  <% end %>
</div>

<script>
	document.addEventListener('turbo:load', () => {
    // Reusable function to set up autocomplete
		function setupAutocomplete(inputField, dropdownClassName) {
			const dropdown = document.createElement('ul');
			dropdown.className = dropdownClassName;
			inputField.parentNode.appendChild(dropdown);

			inputField.addEventListener('input', () => {
				const query = inputField.value;
				const url = `/get_cities?query=${encodeURIComponent(query)}`;

				if (query.length > 2) {
                console.log(`Fetching cities from:`, url); // Debugging log

                fetch(url)
                .then(response => {
                	if (!response.ok) {
                		throw new Error(`HTTP error! status: ${response.status}`);
                	}
                	return response.json();
                })
                .then(data => {
                	dropdown.innerHTML = '';

                	data.locations.forEach(location => {
                		const item = document.createElement('li');
                		item.className = 'autocomplete-item';
                		item.innerHTML = `
                		<div>
                			<div class="location">${location.name}</div>
                			<div class="address">${location.area}, ${location.country}</div>
                		</div>
                		<div class="arrow">&gt;</div>
                		`;
                		item.addEventListener('click', () => {
                			inputField.value = location.name;
                			dropdown.innerHTML = '';
                		});
                		dropdown.appendChild(item);
                	});
                })
                .catch(error => console.error('Error fetching cities:', error));
              } else {
              	dropdown.innerHTML = '';
              }
            });

        // Close dropdown when clicking outside
			document.addEventListener('click', (event) => {
				if (!dropdown.contains(event.target) && event.target !== inputField) {
					dropdown.innerHTML = '';
				}
			});
		}

    // Set up autocomplete for both departure and arrival fields
		setupAutocomplete(document.getElementById('departure_city_select'), 'autocomplete-dropdown');
		setupAutocomplete(document.getElementById('arrival_city_select'), 'autocomplete-dropdown');

		flatpickr("#date_field", {
	    dateFormat: "Y-m-d",        // Format used for the form submission
	    altInput: true,             // Show a more readable date format
	  });
	});
</script>


<style>

	.flatpickr-input {
		width: 100%;
		padding: 8px 10px;
		border-radius: 5px;
		border: 1px solid #ddd;
		font-size: 16px;
	}

	.flatpickr-input:focus {
		border-color: #1D2EF4;
		outline: none;
		box-shadow: 0 0 4px rgba(29, 46, 244, 0.3);
	}

	.search-bar {
		background-color: white;
		border-radius: 25px;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		padding: 10px;
		display: flex;
		align-items: center;
		justify-content: space-between;
		flex-wrap: wrap;
	}
	.search-item {
		display: flex;
		align-items: center;
		padding: 10px 15px;
		border-right: 1px solid #e0e0e0;
		flex: 1 1 100%;
	}
	.search-item:last-child {
		border-right: none;
	}
	.search-item i {
		margin-right: 8px;
		color: #4a4a4a;
	}
	.search-item span {
		color: #4a4a4a;
		font-size: 14px;
		flex: 1;
	}
	.search-item .form-control, .search-item .form-select {
		border: none;
		box-shadow: none;
		font-size: 16px;
	}
	.search-button {
		background-color: #1D2EF4;
		color: white;
		border-radius: 0 25px 25px 0;
		padding: 10px 20px;
		border: none;
		font-size: 14px;
		flex: 1 1 100%;
		text-align: center;
	}
	@media (min-width: 576px) {
		.search-item {
			flex: 1 1 auto;
		}
		.search-button {
			flex: 0 0 auto;
		}
	}

  .autocomplete-dropdown {
    position: absolute;
    background-color: white;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    z-index: 1000;
    list-style: none;
    padding: 0;
    margin: 0;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 5px;
  }

  .autocomplete-item {
    padding: 10px 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .autocomplete-item:hover {
    background-color: #f0f0f0;
  }
  .autocomplete-item .location {
  	font-weight: bold;
  }
  .autocomplete-item .address {
  	color: #6c757d;
  }
  .autocomplete-item .arrow {
  	color: #6c757d;
  }
</style>