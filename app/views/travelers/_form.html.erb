<div class="col-lg-8 mx-auto shadow-sm border p-4 rounded bg-white mt-5 mb-5">
  <h1 class="text-center mb-4">Traveler, Carry For You</h1>

  <%= form_with(model: @traveler, local: true) do |form| %>
   
    <!-- Row for Departure and Arrival -->
    <div class="row mb-4">
      <div class="col-md-3">
        <%= form.label :departure_country, "Departure Country", class: 'form-label' %>
        <%= form.select :departure_country, ISO3166::Country.all.map { |c| [c.translations['en'], c.alpha2] }, 
          { prompt: 'Select a country' }, { id: 'departure_country_select', class: 'form-select' } %>
      </div>

      <div class="col-md-3">
        <%= form.label :departure_city, "Departure City", class: 'form-label' %>
        <%= form.select :departure_city, [], { prompt: 'Select a city' }, { id: 'departure_city_select', class: 'form-select' } %>
      </div>

      <div class="col-md-3">
        <%= form.label :arrival_country, "Arrival Country", class: 'form-label' %>
        <%= form.select :arrival_country, ISO3166::Country.all.map { |c| [c.translations['en'], c.alpha2] }, 
          { prompt: 'Select a country' }, { id: 'arrival_country_select', class: 'form-select' } %>
      </div>

      <div class="col-md-3">
        <%= form.label :arrival_city, "Arrival City", class: 'form-label' %>
        <%= form.select :arrival_city, [], { prompt: 'Select a city' }, { id: 'arrival_city_select', class: 'form-select' } %>
      </div>
    </div>

    <!-- Row for Trip Type -->
    <div class="row mt-4">
      <div class="col-md-12 mb-3">
        <%= form.label :trip_type, "Trip Type", class: 'form-label' %>

        <div id="trip_type_buttons" class="btn-group d-flex flex-wrap justify-content-center" role="group" aria-label="Trip Type">
          <button type="button" class="btn btn-outline-primary mx-1 trip-type-button active" data-value="one_way">
            <%= image_tag "one-way.png", class:"icon-class" %> One Way
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 trip-type-button" data-value="round_trip">
            <%= image_tag "two-way-street.png", class:"icon-class" %> Round Trip
          </button>
        </div>

        <!-- Hidden field to store the selected trip type -->
        <%= form.hidden_field :trip_type, id: 'selected_trip_type', value: @traveler.trip_type %>
      </div>
    </div>

    <!-- Row for Travel Date & Travel Return Date -->
    <div class="col-md-12 mb-3">
      <%= form.label :travel_date, "Travel Date", class: 'form-label' %>
      <%= form.date_field :travel_date, class: 'form-control' %>
    </div>
    <div class="col-md-12 mb-3" id="return_date_container" style="display: none;">
      <%= form.label :travel_return_date, "Travel Return Date", class: 'form-label' %>
      <%= form.date_field :travel_return_date, class: 'form-control' %>
    </div>

    <!-- Row for Parcel Type -->
    <div class="row">
      <div class="col-md-12 mb-3">
        <%= form.label :parcel_type, "Shipment Type", class: 'form-label' %>
        
        <div id="parcel_type_buttons" class="btn-group d-flex justify-content-center" role="group" aria-label="Parcel Type">
          <button type="button" class="btn btn-outline-primary mx-1 parcel-type-button" data-value="Document">
            <%= image_tag "document.png", class:"icon-class" %>
             Document
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 parcel-type-button active" data-value="Parcel">
            <%= image_tag "parcel.png", class:"icon-class" %> Parcel
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 parcel-type-button" data-value="Pallet">
            <%= image_tag "pallet.png", class:"icon-class" %> Pallet
          </button>
        </div>

        <!-- Hidden field to store the selected parcel type -->
        <%= form.hidden_field :parcel_type, id: 'selected_parcel_type' %>
      </div>
    </div>

    <!-- Row for Parcel Qty. -->
    <div class="col-md-6 mt-2 mb-4">
      <%= form.label :parcel_qty, "Quantity", class: 'form-label' %>
      <%= form.number_field :parcel_qty, class: 'form-control', placeholder: 'pcs', min: 0 , id: 'parcel_qty' %>
      <div id="quantity_display" class="mt-2 fw-bold">Quantity: 0</div>
    </div>

    <!-- Row for Transportation -->
    <div class="row">
      <div class="col-lg-12 mb-3">
        <%= form.label :transportation, "Mode of Transportation", class: 'form-label' %>
        
        <div id="transportation_buttons" class="btn-group d-flex flex-wrap justify-content-center" role="group" aria-label="Transportation">
          <button type="button" class="btn btn-outline-primary mx-1 transportation-button" data-value="flight">
            <%= image_tag "plane.png", class:"icon-class" %>
             Flight
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 transportation-button" data-value="car">
            <%= image_tag "car.png", class:"icon-class" %> Car
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 transportation-button" data-value="bus">
            <%= image_tag "bus.png", class:"icon-class" %> Bus
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 transportation-button" data-value="train">
            <%= image_tag "train.png", class:"icon-class" %> Train
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 transportation-button active" data-value="van">
            <%= image_tag "delivery-van.png", class:"icon-class" %> Van
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 transportation-button" data-value="ship">
            <%= image_tag "boat-with-containers.png", class:"icon-class" %> Ship
          </button>
        </div>

        <!-- Hidden field to store the selected parcel type -->
        <%= form.hidden_field :transportation, id: 'selected_transportation' %>
      </div>
    </div>

    <!-- Add Another Parcel -->
    <%# <div class="mb-4">
      <a class="text-primary" href="#">+ Add another parcel</a>
    </div> %>

    <!-- ready_to_buy_for_you -->
    <div class="mb-4 mt-4">
      <div class="row">
        <div class="col-md-5">
          <%= form.label :ready_to_buy_for_you, "Ready to buy for you ?", class: 'form-label' %>
        </div>

        <div class="col-md-4">
          <%= form.radio_button :ready_to_buy_for_you, true, class: 'form-check-input', id: 'ready_to_buy_for_you_yes' %>
          <%= form.label :ready_to_buy_for_you, 'Yes', value: true, class: 'form-check-label mx-2', for: 'ready_to_buy_for_you_yes' %>

          <%= form.radio_button :ready_to_buy_for_you, false, class: 'form-check-input', id: 'ready_to_buy_for_you_no' %>
          <%= form.label :ready_to_buy_for_you, 'No', value: false, class: 'form-check-label mx-2', for: 'ready_to_buy_for_you_no' %>
        </div>
      </div>
    </div>

    <!-- Row for parcel collection mode -->
    <div class="row mt-4">
      <div class="col-md-12 mb-3">
        <%= form.label :parcel_collection_mode, "Model of Collection", class: 'form-label' %>
        
        <div id="parcel_collection_mode_buttons" class="btn-group d-flex justify-content-center" role="group" aria-label="Parcel Collection Mode">
          <button type="button" class="btn btn-outline-primary mx-1 parcel-collection-mode-button" data-value="Hand to Hand My Place">
            <%= image_tag "box.png", class:"icon-class" %>
              Hand to Hand My Place
          </button>
          <button type="button" class="btn btn-outline-primary mx-1 parcel-collection-mode-button active" data-value="Hand to Hand Your Place">
            <%= image_tag "box.png", class:"icon-class" %> Hand to Hand Your Place
          </button>
        </div>

        <!-- Hidden field to store the selected parcel type -->
        <%= form.hidden_field :parcel_collection_mode, id: 'selected_parcel_collection_mode' %>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="d-grid">
      <%= form.submit "Post", class: "btn btn-primary mt-2 fw-bold" %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('turbo:load', () => {
  // Function to fetch and populate cities for a selected country
  const fetchCities = (countrySelectId, citySelectId) => {
    const countrySelect = document.getElementById(countrySelectId);
    const citySelect = document.getElementById(citySelectId);

    if (countrySelect && citySelect) {
      countrySelect.addEventListener('change', function() {
        const selectedCountry = this.value;

        if (selectedCountry) {
          fetch(`/get_cities?country=${selectedCountry}`)
            .then(response => response.json())
            .then(data => {
              citySelect.innerHTML = '<option value="">Select a city</option>';
              data.cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.text = city;
                citySelect.appendChild(option);
              });
            })
            .catch(error => console.error('Error fetching cities:', error));
        } else {
          // Clear the cities dropdown if no country is selected
          citySelect.innerHTML = '<option value="">Select a city</option>';
        }
      });
    }
  };

  // Initialize for both departure and arrival selects
  fetchCities('departure_country_select', 'departure_city_select');
  fetchCities('arrival_country_select', 'arrival_city_select');

  // Function to handle selection buttons
  const handleSelection = (buttonClass, hiddenFieldId) => {
    const buttons = document.querySelectorAll(buttonClass);
    const hiddenField = document.getElementById(hiddenFieldId);

    if (buttons.length > 0 && hiddenField) {
      buttons.forEach(button => {
        button.addEventListener('click', function() {
          buttons.forEach(btn => btn.classList.remove('active')); // Remove active class
          this.classList.add('active'); // Add active class
          hiddenField.value = this.getAttribute('data-value'); // Update hidden field
        });
      });
    }
  };

  // Initialize trip type, transportation, and parcel collection modes
  handleSelection(".trip-type-button", "selected_trip_type");
  handleSelection(".transportation-button", "selected_transportation");
  handleSelection(".parcel-collection-mode-button", "selected_parcel_collection_mode");
  handleSelection(".parcel-type-button", "selected_parcel_type");

  // Handle parcel quantity display
  const quantityInput = document.getElementById("parcel_qty");
  const quantityDisplay = document.getElementById("quantity_display");

  if (quantityInput && quantityDisplay) {
    quantityInput.addEventListener('input', function() {
      const quantityValue = quantityInput.value || 0; // Default to 0 if empty
      quantityDisplay.textContent = `Qty: ${quantityValue}`;
    });
  }

  // Handle trip type and show/hide return date based on selection
  const returnDateContainer = document.getElementById("return_date_container");
  const selectedTripTypeField = document.getElementById("selected_trip_type");

  if (returnDateContainer && selectedTripTypeField) {
    const tripTypeButtons = document.querySelectorAll(".trip-type-button");

    tripTypeButtons.forEach(button => {
      button.addEventListener("click", function() {
        const selectedValue = this.getAttribute("data-value");
        selectedTripTypeField.value = selectedValue;

        // Show/hide return date based on trip type
        returnDateContainer.style.display = selectedValue === "round_trip" ? "block" : "none";
      });
    });
  }
});

</script>
